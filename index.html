<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P&L для производства: интерактивный гид и калькулятор прибыли</title>
    <meta name="description" content="Разберитесь в структуре отчета о прибылях и убытках (ОПиУ) для производственного бизнеса. Интерактивный калькулятор, waterfall-диаграмма и анализ рентабельности.">
    
    <meta property="og:title" content="Отчет о прибыли и убытках (P&L) для производства">
    <meta property="og:description" content="Научитесь читать экономику производства и считать реальную прибыль с помощью интерактивной модели.">
    <meta property="og:type" content="website">

    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 rx=%2220%22 fill=%22%232563eb%22/><path d=%22M20 70 l20-20 l15 15 l25-30 l0 35 l-60 0 Z%22 fill=%22white%22/></svg>">

    <style>
        :root {
            /* Colors */
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --text-main: #1e293b;
            --text-light: #64748b;
            --bg-main: #f8fafc;
            --bg-card: #ffffff;
            --border: #e2e8f0;
            
            /* Spacing & Sizing */
            --container-w: 1100px;
            --radius: 12px;
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --transition: all 0.3s ease;
        }

        /* Base Styles */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            line-height: 1.6;
            color: var(--text-main);
            background-color: var(--bg-main);
            -webkit-font-smoothing: antialiased;
        }

        h1, h2, h3 { line-height: 1.2; font-weight: 700; margin-bottom: 1rem; }
        p { margin-bottom: 1rem; }
        ul { list-style: none; }
        a { text-decoration: none; color: inherit; }

        .container {
            max-width: var(--container-w);
            margin: 0 auto;
            padding: 0 1.5rem;
        }

        .btn {
            display: inline-block;
            background: var(--primary);
            color: white;
            padding: 1rem 2rem;
            border-radius: var(--radius);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            border: none;
            text-align: center;
        }
        .btn:hover { background: var(--primary-dark); transform: translateY(-2px); }

        section { padding: 4rem 0; }
        .section-title { text-align: center; margin-bottom: 3rem; font-size: 2rem; }

        /* Hero Section */
        header.hero {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            color: white;
            padding: 6rem 0;
            text-align: center;
        }
        .hero h1 { font-size: clamp(2rem, 5vw, 3.5rem); margin-bottom: 1.5rem; }
        .hero p { font-size: 1.25rem; color: #94a3b8; max-width: 800px; margin: 0 auto 2rem; }
        .hero-bullets {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-bottom: 3rem;
            flex-wrap: wrap;
        }
        .hero-bullets li { display: flex; align-items: center; gap: 0.5rem; font-weight: 500; }
        .hero-bullets svg { color: var(--success); }
        .hero-disclaimer { font-size: 0.8rem; color: #64748b; margin-top: 2rem; }

        /* Problem Section */
        .problem-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }
        .card {
            background: var(--bg-card);
            padding: 2rem;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }
        .problem-card h3 { color: var(--danger); display: flex; align-items: center; gap: 0.5rem; }
        .conclusion { text-align: center; font-weight: 700; color: var(--primary); font-size: 1.2rem; }

        /* Structure Section */
        .structure-flow {
            max-width: 600px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .flow-item {
            padding: 1rem;
            border: 2px solid var(--border);
            border-radius: var(--radius);
            text-align: center;
            font-weight: 600;
            background: white;
            position: relative;
        }
        .flow-item.result { border-color: var(--primary); background: #eff6ff; }
        .flow-item:not(:last-child)::after {
            content: '↓';
            position: absolute;
            bottom: -22px;
            left: 50%;
            transform: translateX(-50%);
            color: var(--text-light);
            font-size: 1.2rem;
        }

        /* Indicators Explanations */
        .indicators-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
        }
        .indicator-box h4 { font-size: 1.1rem; border-bottom: 2px solid var(--primary); display: inline-block; margin-bottom: 0.5rem; }
        .indicator-box p { font-size: 0.95rem; color: var(--text-light); }

        /* Calculator Main */
        .calculator-container {
            display: grid;
            grid-template-columns: 1fr 1.5fr;
            gap: 3rem;
            background: white;
            padding: 3rem;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }
        @media (max-width: 992px) {
            .calculator-container { grid-template-columns: 1fr; }
        }

        .input-form { display: flex; flex-direction: column; gap: 1.2rem; }
        .input-group { display: flex; flex-direction: column; gap: 0.4rem; }
        .input-group label { font-size: 0.9rem; font-weight: 600; color: var(--text-main); }
        .input-group input {
            padding: 0.8rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            outline: none;
            transition: border-color 0.2s;
        }
        .input-group input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
        .error-msg { color: var(--danger); font-size: 0.75rem; display: none; }

        /* Viz Side */
        .viz-side { display: flex; flex-direction: column; gap: 2.5rem; }
        
        /* Waterfall SVG */
        .chart-box h3 { font-size: 1.1rem; margin-bottom: 1rem; color: var(--text-light); }
        #waterfall-svg { width: 100%; height: 240px; background: #fafafa; border-radius: 8px; }
        
        /* Progress Bars */
        .margins-box { display: flex; flex-direction: column; gap: 1rem; }
        .margin-item { display: flex; flex-direction: column; gap: 0.3rem; }
        .margin-label { display: flex; justify-content: space-between; font-size: 0.85rem; font-weight: 600; }
        .progress-bg { width: 100%; height: 10px; background: var(--border); border-radius: 5px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.5s ease-out; }

        /* Comparison columns */
        .comparison-viz { display: flex; gap: 2rem; align-items: flex-end; height: 150px; padding-top: 2rem; }
        .comp-col { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 0.5rem; height: 100%; justify-content: flex-end; }
        .comp-bar { width: 40px; background: var(--primary); border-radius: 4px 4px 0 0; transition: height 0.5s ease-out; position: relative; }
        .comp-bar::before {
            content: attr(data-val);
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.7rem;
            font-weight: 700;
            white-space: nowrap;
        }
        .comp-label { font-size: 0.75rem; text-align: center; line-height: 1.2; font-weight: 600; }

        /* FAQ Accordion */
        .faq-item { border-bottom: 1px solid var(--border); }
        .faq-trigger {
            width: 100%;
            padding: 1.5rem 0;
            background: none;
            border: none;
            text-align: left;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .faq-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease; }
        .faq-content p { padding-bottom: 1.5rem; color: var(--text-light); }
        .faq-item.active .faq-content { max-height: 200px; }
        .faq-item.active .faq-trigger svg { transform: rotate(180deg); }

        footer { background: #0f172a; color: #94a3b8; padding: 3rem 0; text-align: center; font-size: 0.9rem; }
        
        /* Utils */
        .text-center { text-align: center; }
        .mt-2 { margin-top: 2rem; }
    </style>
</head>
<body>

    <header class="hero">
        <div class="container">
            <h1>Отчет о прибыли и убытках (P&L) для производства</h1>
            <p>Как читать экономику производственного бизнеса, а не просто смотреть на итоговые цифры в бухгалтерии.</p>
            <ul class="hero-bullets">
                <li><svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 14.142l-7 7a1 1 0 01-1.414 0l-3.5-3.5a1 1 0 111.414-1.414L9 14.586l6.293-6.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg> Где формируется прибыль</li>
                <li><svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 14.142l-7 7a1 1 0 01-1.414 0l-3.5-3.5a1 1 0 111.414-1.414L9 14.586l6.293-6.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg> Какие затраты критичны</li>
                <li><svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 14.142l-7 7a1 1 0 01-1.414 0l-3.5-3.5a1 1 0 111.414-1.414L9 14.586l6.293-6.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg> Как интерпретировать показатели</li>
            </ul>
            <a href="#calc" class="btn">Посчитать и разобраться</a>
            <p class="hero-disclaimer">Пример управленческого учета. Отличается от стандартизированной финансовой отчетности (IFRS / РСБУ).</p>
        </div>
    </header>

    <section>
        <div class="container">
            <h2 class="section-title">Почему стандартный отчет не отвечает на управленческие вопросы</h2>
            <div class="problem-grid">
                <div class="card problem-card">
                    <h3><svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6"/></svg> Выручка растет, прибыль — нет</h3>
                    <p>Бухгалтерский баланс фиксирует факт, но не объясняет, почему маржинальность падает при росте объемов.</p>
                </div>
                <div class="card problem-card">
                    <h3><svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg> Непонятно, где теряется маржа</h3>
                    <p>Без разделения на переменные и постоянные затраты невозможно найти "черную дыру" в себестоимости.</p>
                </div>
                <div class="card problem-card">
                    <h3><svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg> Сложно управлять затратами</h3>
                    <p>Если все расходы свалены в одну кучу, вы не видите точку безубыточности и порог рентабельности.</p>
                </div>
            </div>
            <p class="conclusion">Проблема — в структуре отчета, а не в цифрах.</p>
        </div>
    </section>

    <section style="background: #fff;">
        <div class="container">
            <h2 class="section-title">Что такое управленческий P&L</h2>
            <div class="text-center" style="max-width: 800px; margin: 0 auto;">
                <p>Это инструмент для принятия внутренних решений. В отличие от официальной отчетности, здесь затраты группируются по их экономическому поведению, а не по бухгалтерским счетам.</p>
                <p style="font-style: italic; font-size: 0.9rem; color: var(--text-light);">В стандартах (IFRS: IAS 1, IAS 2; РФ: ФСБУ 4/2023, ФСБУ 5/2019) форма и группировки регламентированы для внешних пользователей.</p>
            </div>
        </div>
    </section>

    <section>
        <div class="container">
            <h2 class="section-title">Структура отчета о прибыли и убытках</h2>
            <div class="structure-flow">
                <div class="flow-item">Выручка</div>
                <div class="flow-item">− Переменные издержки</div>
                <div class="flow-item result">= Маржинальный доход</div>
                <div class="flow-item">− Постоянные производственные издержки</div>
                <div class="flow-item result">= Валовая прибыль</div>
                <div class="flow-item">− Операционные издержки</div>
                <div class="flow-item result">= EBITDA</div>
                <div class="flow-item">− Амортизация / Проценты / Налоги</div>
                <div class="flow-item result">= Чистая прибыль</div>
            </div>
            <p class="text-center mt-2" style="font-weight: 600;">Отчет читается строго сверху вниз</p>
        </div>
    </section>
    
    

    <section style="background: white;">
        <div class="container">
            <h2 class="section-title">Как читать показатели</h2>
            <div class="indicators-grid">
                <div class="indicator-box">
                    <h4>Выручка</h4>
                    <p>Объем отгруженной продукции. Отвечает на вопрос: "Сколько рынка мы захватили?"</p>
                </div>
                <div class="indicator-box">
                    <h4>Переменные издержки</h4>
                    <p>Зависят от объема выпуска (сырье, энергия). "Насколько эффективно мы тратим ресурсы на единицу товара?"</p>
                </div>
                <div class="indicator-box">
                    <h4>Маржинальный доход</h4>
                    <p>То, что остается на покрытие постоянных затрат. "Генерирует ли продукт деньги сам по себе?"</p>
                </div>
                <div class="indicator-box">
                    <h4>Постоянные пр. издержки</h4>
                    <p>Аренда цеха, оклады мастеров. "Сколько стоит само наличие завода, даже если он ничего не производит?"</p>
                </div>
                <div class="indicator-box">
                    <h4>Валовая прибыль</h4>
                    <p>Результат работы производства. "Эффективно ли организован производственный процесс?"</p>
                </div>
                <div class="indicator-box">
                    <h4>Операционные издержки</h4>
                    <p>Офис, маркетинг, логистика. "Дорого ли нам обходится управление и продажи?"</p>
                </div>
                <div class="indicator-box">
                    <h4>EBITDA</h4>
                    <p>Прибыль до налогов и кредитов. "Способен ли бизнес сам себя окупать и развиваться?"</p>
                </div>
                <div class="indicator-box">
                    <h4>Чистая прибыль</h4>
                    <p>Итоговый результат собственника. "Сколько реально можно забрать в виде дивидендов?"</p>
                </div>
            </div>
        </div>
    </section>

    <section id="calc">
        <div class="container">
            <h2 class="section-title">Интерактивная модель P&L</h2>
            <div class="calculator-container">
                <div class="input-side">
                    <form class="input-form" id="pl-form">
                        <div class="input-group">
                            <label>Выручка (₽)</label>
                            <input type="number" name="revenue" value="1000000" min="0">
                        </div>
                        <div class="input-group">
                            <label>Переменные издержки (₽)</label>
                            <input type="number" name="variable" value="400000" min="0">
                        </div>
                        <div class="input-group">
                            <label>Постоянные производственные (₽)</label>
                            <input type="number" name="fixed_prod" value="200000" min="0">
                        </div>
                        <div class="input-group">
                            <label>Операционные издержки (₽)</label>
                            <input type="number" name="opex" value="150000" min="0">
                        </div>
                        <div class="input-group">
                            <label>Амортизация (₽)</label>
                            <input type="number" name="depreciation" value="50000" min="0">
                        </div>
                        <div class="input-group">
                            <label>Проценты (₽)</label>
                            <input type="number" name="interest" value="30000" min="0">
                        </div>
                        <div class="input-group">
                            <label>Налоги (₽)</label>
                            <input type="number" name="taxes" value="40000" min="0">
                        </div>
                        <div class="input-group">
                            <label>Изменение запасов (+ / − ₽)</label>
                            <input type="number" name="inventory_change" value="0">
                        </div>
                    </form>
                </div>

                <div class="viz-side">
                    <div class="chart-box">
                        <h3>Путь к прибыли (Waterfall)</h3>
                        <svg id="waterfall-svg" viewBox="0 0 500 240"></svg>
                    </div>

                    <div class="margins-box">
                        <h3>Рентабельность (%)</h3>
                        <div class="margin-item">
                            <div class="margin-label"><span>Маржинальная</span> <span id="lbl-m-md">0%</span></div>
                            <div class="progress-bg"><div class="progress-fill" id="bar-md"></div></div>
                        </div>
                        <div class="margin-item">
                            <div class="margin-label"><span>Валовая</span> <span id="lbl-m-gp">0%</span></div>
                            <div class="progress-bg"><div class="progress-fill" id="bar-gp"></div></div>
                        </div>
                        <div class="margin-item">
                            <div class="margin-label"><span>EBITDA</span> <span id="lbl-m-ebitda">0%</span></div>
                            <div class="progress-bg"><div class="progress-fill" id="bar-ebitda"></div></div>
                        </div>
                        <div class="margin-item">
                            <div class="margin-label"><span>Чистая</span> <span id="lbl-m-net">0%</span></div>
                            <div class="progress-bg"><div class="progress-fill" id="bar-net"></div></div>
                        </div>
                    </div>

                    <div class="comparison-box">
                        <h3>Сравнение прибыли</h3>
                        <div class="comparison-viz">
                            <div class="comp-col">
                                <div class="comp-bar" id="bar-comp-mgmt" data-val="0"></div>
                                <span class="comp-label">Управленческая</span>
                            </div>
                            <div class="comp-col">
                                <div class="comp-bar" id="bar-comp-std" data-val="0" style="background: var(--text-light);"></div>
                                <span class="comp-label">Стандартная<br>(с запасами)</span>
                            </div>
                        </div>
                        <p style="font-size: 0.75rem; color: var(--text-light); margin-top: 1rem;">Разница возникает из-за капитализации части затрат в остатках на складе.</p>
                    </div>
                </div>
            </div>
        </div>
    </section>
    
    

    <section>
        <div class="container">
            <h2 class="section-title">Почему цифры могут быть разными</h2>
            <div class="problem-grid">
                <div class="card">
                    <h4>Разные цели</h4>
                    <p>Бухгалтерия считает налоги, управление — эффективность.</p>
                </div>
                <div class="card">
                    <h4>Влияние запасов</h4>
                    <p>В стандартах часть расходов "засыпает" в себестоимости склада и не попадает в отчет периода.</p>
                </div>
                <div class="card">
                    <h4>Методология</h4>
                    <p>Это не ошибка, а разные взгляды на одну и ту же реальность.</p>
                </div>
            </div>
        </div>
    </section>

    <section id="faq">
        <div class="container" style="max-width: 800px;">
            <h2 class="section-title">Вопросы и ответы</h2>
            <div class="faq-item">
                <button class="faq-trigger">
                    Чем отличается от бухгалтерского отчета?
                    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M19 9l-7 7-7-7"/></svg>
                </button>
                <div class="faq-content">
                    <p>Бухгалтерский отчет жестко регламентирован государством. Управленческий P&L гибкий: он группирует затраты так, чтобы видеть маржинальность каждого продукта и эффективность цеха отдельно от офиса.</p>
                </div>
            </div>
            <div class="faq-item">
                <button class="faq-trigger">
                    Можно ли использовать для управления?
                    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M19 9l-7 7-7-7"/></svg>
                </button>
                <div class="faq-content">
                    <p>Нужно! Именно этот отчет показывает точку безубыточности и помогает понять, можно ли давать скидки клиентам или пора сокращать административные расходы.</p>
                </div>
            </div>
            <div class="faq-item">
                <button class="faq-trigger">
                    Почему EBITDA важна?
                    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M19 9l-7 7-7-7"/></svg>
                </button>
                <div class="faq-content">
                    <p>EBITDA очищает прибыль от влияния "бумажной" амортизации и условий кредитования. Это лучший способ сравнить эффективность двух производств с разным парком оборудования.</p>
                </div>
            </div>
        </div>
    </section>

    <section style="background: white; text-align: center;">
        <div class="container">
            <h2 style="font-size: 2.2rem;">Готовы внедрить учет?</h2>
            <p style="margin-bottom: 2.5rem;">Начните с моделирования своих данных прямо сейчас.</p>
            <a href="#calc" class="btn">Попробовать на своих цифрах</a>
        </div>
    </section>

    <footer>
        <div class="container">
            <p>Материал носит образовательный характер. Пример управленческого учета.</p>
            <p style="margin-top: 1rem; opacity: 0.5;">© 2024 Производственная Экономика</p>
        </div>
    </footer>

    <script>
        // FAQ Accordion
        document.querySelectorAll('.faq-trigger').forEach(trigger => {
            trigger.addEventListener('click', () => {
                const item = trigger.parentElement;
                const isActive = item.classList.contains('active');
                
                document.querySelectorAll('.faq-item').forEach(i => i.classList.remove('active'));
                if (!isActive) item.classList.add('active');
            });
        });

        // Calculator Logic
        const form = document.getElementById('pl-form');
        const waterfallSvg = document.getElementById('waterfall-svg');

        function updateViz() {
            const fd = new FormData(form);
            const data = {};
            for (let [key, value] of fd.entries()) {
                data[key] = parseFloat(value) || 0;
            }

            // Calculations
            const margin_income = data.revenue - data.variable;
            const gross_profit = margin_income - data.fixed_prod;
            const ebitda = gross_profit - data.opex;
            const net_profit = ebitda - data.depreciation - data.interest - data.taxes;
            
            // Standard Accounting Logic (Simplified: inventory change increases profit)
            const std_profit = net_profit + data.inventory_change;

            // Update Progress Bars (Ratios)
            const updateMargin = (id, val, total) => {
                const ratio = total > 0 ? (val / total) * 100 : 0;
                const el = document.getElementById(id);
                el.style.width = Math.max(0, Math.min(100, ratio)) + '%';
                document.getElementById('lbl-m-' + id.split('-')[1]).innerText = Math.round(ratio) + '%';
            };

            updateMargin('bar-md', margin_income, data.revenue);
            updateMargin('bar-gp', gross_profit, data.revenue);
            updateMargin('bar-ebitda', ebitda, data.revenue);
            updateMargin('bar-net', net_profit, data.revenue);

            // Update Comparison Bars
            const maxProfit = Math.max(Math.abs(net_profit), Math.abs(std_profit), 1000);
            const mgmtBar = document.getElementById('bar-comp-mgmt');
            const stdBar = document.getElementById('bar-comp-std');

            mgmtBar.style.height = (Math.max(0, net_profit) / maxProfit * 100) + 'px';
            mgmtBar.setAttribute('data-val', Math.round(net_profit).toLocaleString());
            
            stdBar.style.height = (Math.max(0, std_profit) / maxProfit * 100) + 'px';
            stdBar.setAttribute('data-val', Math.round(std_profit).toLocaleString());

            // Waterfall SVG Generation
            renderWaterfall(data.revenue, data.variable, data.fixed_prod, data.opex, (data.depreciation + data.interest + data.taxes), net_profit);
        }

        function renderWaterfall(rev, v_cost, f_cost, opex, final_deducts, net) {
            const max = Math.max(rev, 1);
            const scale = 180 / max; // Height scale
            const w = 60;
            const gap = 15;
            
            let html = '';
            let currentY = 220; // Bottom baseline
            let currentX = 20;

            const addBar = (label, value, type, acc) => {
                const barH = Math.abs(value) * scale;
                let barY;
                let color = 'var(--primary)';

                if (type === 'start') {
                    barY = currentY - barH;
                    color = '#2563eb';
                    acc = value;
                } else if (type === 'sub') {
                    barY = currentY - (acc * scale);
                    color = '#ef4444';
                    acc -= value;
                } else { // Total
                    barY = currentY - (value * scale);
                    color = value >= 0 ? '#10b981' : '#ef4444';
                    acc = value;
                }

                html += `<rect x="${currentX}" y="${barY}" width="${w}" height="${barH}" fill="${color}" rx="2" />`;
                html += `<text x="${currentX + w/2}" y="${currentY + 15}" font-size="9" text-anchor="middle" fill="#64748b">${label}</text>`;
                
                currentX += w + gap;
                return acc;
            };

            let accumulator = 0;
            accumulator = addBar('Выручка', rev, 'start', accumulator);
            accumulator = addBar('Перем.', v_cost, 'sub', accumulator);
            accumulator = addBar('Пост. пр.', f_cost, 'sub', accumulator);
            accumulator = addBar('Опекс', opex, 'sub', accumulator);
            accumulator = addBar('Нал/Ам/%', final_deducts, 'sub', accumulator);
            addBar('Чистая', net, 'total', accumulator);

            waterfallSvg.innerHTML = html;
        }

        form.addEventListener('input', updateViz);
        window.addEventListener('load', updateViz);
    </script>
</body>
</html>
